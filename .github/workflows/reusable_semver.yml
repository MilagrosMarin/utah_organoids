# Tasks that require semantic versioning info for tags/releases
name: Semantic Versioning (Reusable)
on:
  workflow_call:
    inputs:
      create_release:
        description: "Set to false to always skip creating a new tag and release"
        default: true
        type: boolean
        required: false
      release_types:
        description: "List of single-quoted, comma separated values of release type names to be considered for release, e.g., major,minor,patch"
        default: major,minor,patch
        type: string
        required: false
      release_branch:
        description: "The originating branch that is allowed to trigger pushing version changes and creating releases. Otherwise, only version information is collected."
        default: main
        type: string
        required: false
      bump_worker_image_version:
        description: "Set to 'true' to bump the version of the worker image in the workflow file"
        default: false
        type: boolean
        required: false

    outputs:
      new_tag:
        description: "New tag with the 'v' prefix"
        value: ${{ jobs.get_version.outputs.new_tag }}
      new_version:
        description: "New version without the prefix"
        value: ${{ jobs.get_version.outputs.new_version }}
      previous_tag:
        description: "Previous tag with the 'v' prefix"
        value: ${{ jobs.get_version.outputs.previous_tag }}
      previous_version:
        description: "Previous version without the prefix"
        value: ${{ jobs.get_version.outputs.previous_version }}
      release_type:
        description: "Release type for new version"
        value: ${{ jobs.get_version.outputs.release_type }}
      changelog:
        description: "Changelog generated from commits"
        value: ${{ jobs.get_version.outputs.changelog }}
      datetime:
        description: "Datetime when action was used"
        value: ${{ jobs.get_version.outputs.datetime }}
      bumped:
        description: "Version files were bumped"
        value: ${{ jobs.get_version.outputs.bumped }}
      id:
        description: "The identifier of the created release"
        value: ${{ jobs.create_tag_and_release.outputs.id }}
      html_url:
        description: "The HTML URL of the release"
        value: ${{ jobs.create_tag_and_release.outputs.html_url }}
      upload_url:
        description: "The URL for uploading assets to the release"
        value: ${{ jobs.create_tag_and_release.outputs.upload_url }}

jobs:
  get_version:
    name: Get latest version information
    runs-on: ubuntu-latest
    steps:
      - name: üõéÔ∏è  Checkout repository
        id: checkout-repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: üïí  Set datetime
        id: set-datetime
        run: echo "datetime=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >>$GITHUB_OUTPUT
        shell: bash

      - name: üè∑Ô∏è  Get new semantic version string
        id: semver_tag
        uses: mathieudutour/github-tag-action@v6.1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          release_branches: ${{ inputs.release_branch }}
          pre_release_branches: develop,dev,wip
          fetch_all_tags: true
          dry_run: true
          default_bump: false
          custom_release_rules: force_bump_patch:patch:Misc.,force_bump_minor:minor:Updates,force_bump_major:major:Breaking Changes

      - name: üêõ  Correct no version
        id: correct-no-version
        run: |
          echo "bumped=false" >>$GITHUB_OUTPUT
          # if new tag is empty, then set to previous tag and set bumped to false
          if [ -z "${{ steps.semver_tag.outputs.new_tag }}" ]; then
            echo "new_tag=${{ steps.semver_tag.outputs.previous_tag }}" >>$GITHUB_OUTPUT
            echo "new_version=${{ steps.semver_tag.outputs.previous_version }}" >>$GITHUB_OUTPUT
          # otherwise, set new tag and version, and bumped to true only if they are different
          else
            echo "new_tag=${{ steps.semver_tag.outputs.new_tag }}" >>$GITHUB_OUTPUT
            echo "new_version=${{ steps.semver_tag.outputs.new_version }}" >>$GITHUB_OUTPUT
            if [ "${{ steps.semver_tag.outputs.new_tag }}"!="${{ steps.semver_tag.outputs.previous_tag }}" ]; then
              echo "bumped=true" >>$GITHUB_OUTPUT
            fi
          fi
          # create json array from release types string
          RELEASE_ONLY="[\"$(echo "${{ inputs.release_types }}" | sed "s/\\,/\"\\,\"/g" | sed 's/ //g')\"]"
          echo "release_array=${RELEASE_ONLY}" >>$GITHUB_OUTPUT
          echo "branch_name=${GITHUB_REF##*/}" >>$GITHUB_OUTPUT
        shell: bash

    outputs:
      new_tag: ${{ steps.correct-no-version.outputs.new_tag }}
      new_version: ${{ steps.correct-no-version.outputs.new_version }}
      previous_tag: ${{ steps.semver_tag.outputs.previous_tag }}
      previous_version: ${{ steps.semver_tag.outputs.previous_version }}
      release_type: ${{ steps.semver_tag.outputs.release_type }}
      changelog: ${{ steps.semver_tag.outputs.changelog }}
      datetime: ${{ steps.set-datetime.outputs.datetime }}
      release_array: ${{ steps.correct-no-version.outputs.release_array }}
      bumped: ${{ fromJSON(steps.correct-no-version.outputs.bumped) }}
      branch_name: ${{ steps.correct-no-version.outputs.branch_name }}

  update_version_files:
    name: Update version files
    runs-on: ubuntu-latest
    needs: get_version
    if: |
      always() && 
      (needs.get_version.result == 'success') && 
      fromJSON(needs.get_version.outputs.bumped) && 
      (inputs.release_branch == needs.get_version.outputs.branch_name)
    steps:
      - name: üõéÔ∏è  Checkout repository
        id: checkout-repo
        uses: actions/checkout@v3

      - name: üêç  Bump pyproject.toml version
        id: update-pyproject-dot-toml
        run: |
          PKG_VERSION_FILE=pyproject.toml
          PREV_PKG_VER=$(grep -Po "(?<=^version = )(\"|').*(\"|')$" "$PKG_VERSION_FILE" | cut -d '"' -f 2 | cut -d "'" -f 2)
          echo "current package version: PREV_PKG_VER=$PREV_PKG_VER"
          [[ -z $PREV_PKG_VER ]] && exit 1
          LINE_NO=$(awk -v pat="^version" '$0~pat{print NR}' "$PKG_VERSION_FILE")
          sed -i "$LINE_NO s/.*/version = \"${{ needs.get_version.outputs.new_version }}\"/" "$PKG_VERSION_FILE"
        shell: bash

        # TODO: bump all build.env files in loop
      - name: ‚¨ÜÔ∏è  Bump worker env file version
        id: update-worker-env-file
        if: inputs.bump_worker_image_version
        run: |
          BUILD_ENV_FILE=./docker/standard_worker/build.env
          LINE_NO=$(awk -v pat="WORKFLOW_VERSION" '$0~pat{print NR}' "$BUILD_ENV_FILE")
          sed -i "$LINE_NO s/.*/WORKFLOW_VERSION=${{ needs.get_version.outputs.new_version }}/" "$BUILD_ENV_FILE"
        shell: bash

      - name: üìú  Update changelog
        id: update-changelog
        run: |
          if [[ -z "${{ needs.get_version.outputs.changelog }}" ]]; then
            echo "No changelog content to update"
            exit 0
          fi
          if [[ ! -f CHANGELOG.md ]]; then
            echo "No CHANGELOG.md file found"
            exit 0
          fi
          echo -e "changelog=\n${{ needs.get_version.outputs.changelog }}"
          NEWSEC_STR="## \`${{ needs.get_version.outputs.new_tag }}\`"
          CHANGELOG_STR=$(sed '1d' <<< "${{ needs.get_version.outputs.changelog }}")
          echo -e "NEWSEC_STR=${NEWSEC_STR}\nCHANGELOG_STR=\n${CHANGELOG_STR}"
          [[ -z "${CHANGELOG_STR}" ]] && exit 0
          sed -i '/Changelog/r'<(printf "\n%s\n%s\n\n" "$NEWSEC_STR" "$CHANGELOG_STR") CHANGELOG.md
        shell: bash

      - name: üìå  Push versioning changes
        id: push-ver-changes
        run: |
          echo -e "Committing and pushing:\n$(git status --porcelain)"
          if [ -z "$(git status --porcelain)" ]; then
            echo "No versioning file changes."
            exit 0
          fi
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add .
          git commit -m "update files with new version"
          git push origin HEAD:${{ inputs.release_branch }}
        shell: bash

  create_tag_and_release:
    name: Create tag and release
    needs:
      - get_version
      - update_version_files
    if: |
      always() && 
      (needs.get_version.result == 'success') && 
      (needs.update_version_files.result == 'success') && 
      fromJSON(needs.get_version.outputs.bumped) && 
      (inputs.release_branch == needs.get_version.outputs.branch_name) && 
      (inputs.create_release)
    runs-on: ubuntu-latest
    steps:
      - name: üõéÔ∏è  Checkout repository
        id: checkout-repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: üè∑Ô∏è  Create and push a new semver tag
        id: push-new-tag
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git tag -a ${{ needs.get_version.outputs.new_tag }} --force -m "tagging ${{ needs.get_version.outputs.new_tag }}:${{ inputs.release_type }}"
          git push -f origin ${{ needs.get_version.outputs.new_tag }}
        shell: bash

      - name: üì¶  Create a new release from semver tag
        id: release-version
        if: |
          (!contains('pre', ${{ needs.get_version.outputs.release_type }})) &&
          (contains(fromJSON(${{ needs.get_version.outputs.release_array }}), ${{ needs.get_version.outputs.release_type }}))
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ needs.get_version.outputs.new_tag }}
          name: ${{ needs.get_version.outputs.release_type }} release ${{ needs.get_version.outputs.new_version }}
          body: ${{ needs.get_version.outputs.changelog }}
          allowUpdates: true
          generateReleaseNotes: true

    outputs:
      id: ${{ steps.release-version.outputs.id }}
      html_url: ${{ steps.release-version.outputs.html_url }}
      upload_url: ${{ steps.release-version.outputs.upload_url }}
