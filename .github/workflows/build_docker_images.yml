name: Docker Image Build
on:
  push:
    branches:
      - main
    tags:
      - v*
  workflow_run:
    workflows:
      - Version Tag Release
    types:
      - completed
    branches:
      - main
  workflow_dispatch:

jobs:
  get_last_pushed_tag:
    name: Get the last pushed tag name
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags')) ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.event == 'push') || 
      (github.event_name == 'workflow_dispatch')
    steps:
      - name: ðŸ›Žï¸  Checkout repository
        id: checkout-repo
        uses: actions/checkout@v3

      - name: ðŸ·ï¸  Get last pushed tag
        id: get-last-pushed-tag
        run: |
          git fetch --prune --unshallow
          echo "LAST_TAG="$(git describe --tags --abbrev=0 2>/dev/null | cut -d "v" -f 2)"" >>$GITHUB_ENV
          echo "Using tag ${LAST_TAG}"
        shell: bash

    outputs:
      version: ${{ env.LAST_TAG }}

  call_sciops_docker_image_debian:
    name: Build SciOps Docker image (Debian)
    uses: dj-sciops/djsciops-cicd/.github/workflows/sciops_docker_images.yaml@main
    needs: get_last_pushed_tag
    if: needs.get_last_pushed_tag.result == 'success'
    with:
      jhub_ver: 1.4.2
      py_ver: 3.9
      dist: debian
      workflow_version: ${{ needs.get_last_pushed_tag.outputs.version }}
      release_upload_url: ""
    secrets:
      BOT_SSH_KEY: ${{secrets.BOT_SSH_KEY}}
      REGISTRY_USERNAME: ${{secrets.REGISTRY_USERNAME}}
      REGISTRY_PASSWORD: ${{secrets.REGISTRY_PASSWORD}}
